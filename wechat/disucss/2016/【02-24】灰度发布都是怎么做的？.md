> 转载自：<http://mp.weixin.qq.com/s?__biz=MzA3MDA2MjE2OQ==&mid=402089917&idx=1&sn=78a0132d079d16d5620a169956fadb82&scene=23&srcid=0225xyoPSzvt7ydXLBrshMWY#rd>

#### 今日话题

灰度发布都是怎么做的？

1. 我们移动端做灰度的时候，就是靠读配置文件，然后给指定用户群开特定的功能，或是单独升级；-刘天昭

2. 我们游戏版本更新，做灰度就是更新只更新一个大区，这个大区的玩家相当于是做测试，等灰度后的几天才是全大区更新；-逍遥自在

3. 我们现在的灰度发布用的比较笨的方法 两套代码 合到一个项目中 ，然后根据不同的权限访问不同的代码 这样的话 就是 一些公用的业务 也就有两套代码了；-陈阳

4. 来源：知乎  
一切的前提都是：1. 做好版本管理（一个有条理、敬畏秩序的、能写代码的发布经理）；2. 打好数据桩（重点注意按版本观测所有数据，数据要贯通不要片段）；3. 灰度版本有回收能力（不然老板时不时因为微博用户报告的某个灰度版本的 bug 来让你擦屁股就不用干正事了）；-刘天昭

5. 灰度在lnmp下面，简单方案就是在nginx接入的时候，里面写一段lua，比如按照用户的IP或者某个cookie进行取模，然后某个值的用户可以访问新业务。这个服务可以是干负载，我统称叫做接入层，不管是硬件，还是lvs这种，还是nginx，还是haproxy，或者varnish，都差不多；-black

6. 可以用openresty；-刘天昭

7. openResty新浪手机客户端那边在用，而且还开发了一个基于它的框架，Vanilla；-tiyee

8. 运维更新的时候如果是从批量里可以基于 ansible 的 limit host ，可以单独一台台，或者小批量的发布，然后在全量；-宋明明

9. 但是有一点，灰度发布如果没有测量手段，就是扯蛋[呲牙]；-乔楚

10. 针对分布式部署系统，可以通过脚本或可视化工具，把代码推送到一台机器上，然后绑定host测试，无误后再推送全网。-Meow

11. 问:灰度发布怎么理解。一小部分用户使用与其他不同用户的功能页面。类似内测封测么？-zhangsheng  
回：灰介于黑白之间，如果就几十台机器就别琢磨灰度了。-王春光

15. 我起个头吧，我们之前只有几十台机，做法很简单，根据需求动态生成一个js文件，js文件匹配到一个合适的用户种一个cookie。nginx根据反向代理检查请求是否包含该cookie,是的话把请求导到新机器。-李小邪

16. 小道消息腾讯qqmisic是基于qq号码做的,如果网站分布城市，可以做基于城市做;  
@李小邪的方法不错;  
我觉得核心就是做个tag然后识别这个tag,也叫特征,具体细节怎么分，还看自身业务。-@理鱼：

17. app也有灰度机制，比如android只针对特定渠道的部分用户做升级，然后观察用户使用情况；
这个还是要贴近业务的，原来我们做游戏的时候就是分服或分区，先一个分区或者一个服升级，观察几个小时没有异常再全部升级。一般的网站业务可以先升级一台服务器，一般每台服务器是按地区划分的。如果是upstream或者lvs这样就不太合适，看自己的业务了，总之升级一定要做好回滚方案，用户操作日志一定要有，就算经过严格的测试有时也可能存在bug，特别是涉及到金钱的业务，万一出问题还要有补偿的方案。-钱志强

18. 今天的话题是灰度？机器灰度的话，先机器分组啊，然后一组一组发布啊，数据灰度的话没做的数据单元化的数据很难搞，暂时没搞过。-种树人

19. 问：灰度的话如果表字段变了怎么灰？-菜包子
回：数据隔离层处理~通常出现于数据可回滚的业务场景。-Acadine 马宇翔

20. 十个节点，灰度部署两个，负载均衡根据url或特点解析，遇到灰度功能将请求指到灰度机上；-魏海龙

21. 这个需要按照特征来做吧，比如刷选用户的人群，给用户打tag然后分票；  
取模有问题，如果我增加你取模就会导致之前的灰度用户失效，取模存在一至性；  
其实也不多，具体看tag吗，你可以把cookie的某部分做tag就容易了，当我做灰度时很简单，每次放10%；  
没你想的那么复杂。其实就是按照某一特征做一堆票。特征不需要限制太死。如cookie区地域+活跃。这些都有。每个用户都必须有的特征标签。-金灶沐

22. 灰度这个话题好，灰度可极大降低一个变更风险；想看看大家都是怎么玩的；我们这边目前只针对服务器做灰度上线，对web或java后台逻辑层的变更，先把目标灰度服务器的流量引走，代码变更后人工在灰度环境测试，灰度测试没问题后代全量发布。当然不是所有的变更都支持按照服务器灰度，不能灰度的需要开发主管作出说明；  
另外就是开发在业务逻辑做灰度，如果按照用户特征（特征也一定高大上，最简单的比如一个分组或者hardcode），或者其他业务的特征（如呼叫的几条线路）；
特征不一定高大上。-klein

23. 我平常用的多的灰度发布是web项目功能版本更迭。方法跟@klein的差不多。这个灰度的前提是别改原有数据库字段，否则数据库结构的变更是个麻烦事，容易出问题。  
如果非要改字段，那只能先把用到这个字段的老功能暂停使。-李三

24. 数据库这块也应该灰度下，比如灰度的这部分数据库，都会放到一台或一部分数据库中。-斯图尔特


#### 分享链接

1. https://yq.aliyun.com/articles/5586?spm=5176.100238.yqhn2.2.MrUbwK MySQL · 引擎特性 · InnoDB文件系统管理；

2. [ext3，ext4，xfs和btrfs文件系统性能对比 : http://m.blog.csdn.net/article/details?id=41213253]