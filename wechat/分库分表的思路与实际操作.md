> 转载自：<http://mp.weixin.qq.com/s?__biz=MzA3MDA2MjE2OQ==&mid=203895639&idx=1&sn=b19f08be175489f098f1f23993319d53&scene=1#rd>

1. 如何分库分表，这个是如何写的问题，而如何写是根据你的读取方便和数据量、访问量分布来决定的，所以几乎是跟业务绑定的，而如何分库分表例如可以按照用户啦、时间区间啦等等来进行，分库分表之后读取肯定就不方便了，但是可以通过一些数据冗余，例如数据库按照用户分区，而可能你要按照其他东西读取，那么你就可以在例如hbase、cassandra、mysql等存储一份冗余来满足其他读取 - diwayou@高鹏

2. 以前我用分表就是根据该表的id来分，id/100（1000 10000）分表，查询什么的就根据写好方法返回当前所在表 - 指尖上的艺术家

3. 我来说个场景吧，比如存储用户信息 - tywei

回: 那适合用hash类的方式 - 黑夜路人

4. 分表不适合数据高速发展的业务，每隔一段时间就得考虑一下重新分表和各种数据冗余问题。很多业务数据，可以用redis这样的K-V 数据库代替，采用一致性哈希，扩展很容易。微博的用户关系是这么做的，MySQL就作为备份了 - hilojack

5. 问: 分表以后的查询要如何做？ 数据都分散了 - 大熊

回: 每一个都查一遍？mergr起来？- Ragnarok

回: 有关联冗余的,而且也有计算规则. 而且查询都是有目的性的查询的.字段也好,区间也好,都是定向的 - 麦哥

回: 分表以后什么的查询?常规数据通过id从cache拿….如果需要搜索的的数据又没有搜索系统,只能考虑冗余了..区间的如果非要在表里查询,就根据区间跨表查然后业务层或者proxy层处理 - Reilost

回: @大熊 数据库中，就不可能有类是的索引表. 如果可以这样的索引表，那直接就可以用来建立其他的表了。无非就是多占点硬盘空间嘛 - A.刘波@云软科技

6. 数据库分库分表，应该划分为两种：一种是因项目业务考虑，而进行对原表的重构（纵向的），增加冗余来提升检索的效率。一种是因表结构不变化，横向切割，增加多表来稳定存储能力。 - A.刘波@云软科技

7. 问: 比如  会员按地域存在各个表里  但后台想看全体会员列表呢 - 轻裘长剑

回: — —…不要求排序的话可以分别展示各地区的吧 - Reilost

回: @轻裘长剑  其实，有的时候，要退一步海阔天空。 你的全体列表的实际作用如果仅仅只为后台管理一处。那么就可以断定，他的存在是没有必要性的。 - A.刘波@云软科技

回: 这种需求是可以规避或者转化的需求. 如果实在必须需要,那只能proxy层或者业务层想办法 - Reilost

回: 你可以先有个引导性。对。先有地区，再引导到 相应地区的列表里。 - A.刘波@云软科技

8. 实例：商品库存表, 软件定制方要求一类一模型，模型存在主副表；这个过程，已经可以算是对商品的表按照商品的不同属性进行了业务分割了。达到了数据库的分库，分表的操作。但问题来了。商家进行商品管理的时候获得商品列表，需要构建的查询语句很费事，要不就是对所有的模型取出，进行一次FOR循环，获得很长很长的SQL。要不就是对一个模型一个模型的查询，获得综合数据。
这个时候，有的同学就说了。那再构造一张表。专门用来存储基本字段，便于卖家去检索数据。
其实，问题又回到了当时在构造多模型商品表的阶段了。
那这个问题的解决方法就是：  构造 N张 商家的发布记录表。
还是会存在，存储压力的问题。
按照 商家的ID ，进行HASH 取值，然后获得他的发布记录，应该存储在什么表。
这样，即解决了 商品的存储多库多表，又解决了卖家的发布记录的多库多表。
- A.刘波@云软科技

9. 问: 分库分表后 如何分页出数据列表呢 - 周渊

回: @周渊  如果你的分表原则，例如员工的每天的报表，你按照时间分表，那么当日的分表，就是在本数据库，数据的分页自然不是问题。
如果以日作为分割点，你需要月的列表。也能做。
如果你是以业务做分割，例如京东的商品。 食品类和电器类是不同库的数据。你需要他们这两个不同库的数据的集合形成分表
那自然不是分表做的事情了。你可能需要额外的措施，例如检索引擎。
- A.刘波@云软科技

10. 问: 以前遇到过一个问题，大约3000万条用户记录，要求可以根据姓名、账号、身份证号快速模糊查询，这种情况各位会怎么分表呢 - 马犇

回: 上搜索引擎 - 黑夜路人

回: @马犇  redis  hash 用户数据， 再根据 各种要差的，建立 key - A.刘波@云软科技

11. 建立冗余结构应对新的需求
如果存在业务变动，可以基于新的业务，建立冗余结构。
然后，你出现了一个强需求，是基于B查询的，而这个需求的频率和之前的一样，那么就需要做冗余结构。也就是同样的数据，在基于A分表之外，再做一个基于B分表的结构。
例如：基于A你分了16个表：tablea1 tablea2,tablea3…，现在遇到b查询很重要，就需要基于B的分表：tableb1,tableb2,tableb3。只是当进行增加，删除，修改的时候，以前只操作一份，这样就需要操作两份。 - XiangZ

12. @XiangZ 这个方案能解决问题，但不算一个好方案
数据库分区、分表、分库其实已经是烂熟了的技术，所有的sharding必须基于线上业务（不包括统计）的查询条件来设计，反过来，如果基于某字段条件拆分了，那么查询条件就要受到制约，比如：某字段一般都作为条件查询，那么可以基于该条件分区，反过来，基于该字段分区，那么查询条件就要尽量加上该字段；如果某字段一定作为条件，那么就可以基于该字段分表，反之亦然；如果某字段一定作为条件，且对一致性要求不是很高，那么可以基于该字段分表并且可以放到不同的数据库上。如果分表还不能解决数据库压力问题，那么就要考虑数据库分域、系统拆分了。 - 水浸街

13. 前面有同学提到建索引表，我们也有用过，不过是放在缓存里，用于解决必须分表，但分表字段又不一定作为条件的情况，比如用户表，查询条件有编号、用户名二者之一，需要用kv把其中一个映射到分表字段上 - 水浸街

14. 问： 如果一个系统v1版按照查询条件来分表分库很顺利。但是v2版来了个新产品经理 一些需求和数据分表有矛盾 怎么弄呢 - 周渊

回： 这个貌似不是技术问题，需要通过沟通达成共识 - 水浸街

15. 基于用户id数据的结构，维护一个用户id与数据库，数据表的关系，新用户第一次插入数据时分配到最合理的表中（规则自己定），以后还可以随时扩展新的库和表，无需迁移数据，缺点是每次对数据操作前先拿到用户信息所在库和表 - 张清柱

16. 按天分表，按字母顺序分表，按长用和很少用分 - 赵义杰

17. 主要看实际应用场景吧，像财务系统，一年一账套，按年分表，日志类的基本按天吧 - 徐刚

18. 一致性hash可能用来做cache比较合适，减少惊群，分表分库还是适当考虑业务相关 - shawnvan

19. 对，用于cache更合适些~ 分表常规来说按照数字取模分；按照日期划分；按照数据量（体积）划分都更为合适。怎么分表关键取决于业务模型，尤其是写入的关联度（事务）和读取是否会跨多表等。 - xingxing

20. 先估量，再看冷热，一般业务不是很夸张的话，热数据，不会太多，而且前面还有 cache 挡着呢，业务性就更重要了. 数据落地，只要不是电商订单这种的，数据库实在是吃不住了，走个消息队列，一般来讲也不是什么大问题应该 - shawnvan

21. 分区和分表貌似解决的点不同？分区主要是分摊磁盘 io?而且应该可以一起用的.分区对代码透明的，这个倒是一大优点 - shawnvan

22. 分区改善磁盘io，这需要满足一定的条件才行：查询语句包含分区字段，查询语句未使用索引或使用了分区索引. 另外，把不同分区放到不同磁盘也能改善磁盘io - 水浸街

23. @水浸街  mysql的分区技术也不是太好。如果多路数据存储到多个盘，性能就是好很多。
现在已经有技术能够在三块SAS的盘并行的情况，IO性能比SSD要好。
不过需要hack Linux OS层，在block write的时候hack一下，不动文件系统和磁盘驱动部分。
三块SAS空间巨大，大概是space * 3的容量。SSD容量少，价格高。
没有链接，私有技术。主要是云计算公司在弄。
本质就是多路写入的方式。因为SAS是硬件方式。
写入读取都需要多路，同时要保证非脏读写，对技术要求比较高。
跟raid的一些方式类似。
- 黑夜路人

24. 问: 分库分表是否能用分区完全取代. 两者性能哪个更优 - LAMP李捷

回: 分区是DBA的工作吧. 不能算是程序员的技能。那是物理技能. 我觉得不可同谈。分区，是从物理角度去做的工作。分库分表，更多是从业务发展去考虑程序设计。 - A.刘波@云软科技

回: 分区和分库还是很不一样的  而且分区用不好问题会更严重 据我了解一般用分区的不多 我们用过分区 对业务限制更大
分区这种事真心不能让运维自己决定. 分不好 一个sql变成读取所有分区文件 io直接翻n倍 - kunsir

25. 分表是不是分为两种. 一种是横向的一种是纵向的，即将一个表拆成相同结构的n个表，或者把一个表个别几个字段拆出来独立一个表 - Neo

回: 横向，是均衡数据. 纵向，也叫表重构或业务重构 - A.刘波@云软科技

26. 问: 大家觉得，在数据库结构设计过程中，推荐serializa这类序列化的字段吗 - 次子小标

回: 得看具体需求吧。太长的不推荐，建议有一个专门的文本库，数据库中只存文本ID. 序列化的字段有2个问题，第一是字段多了，变长存储带来的一些性能问题。第二是，这些字段无法建索引，有查询需求就很麻烦了 - 廖强

回: 我以前的做法是，新建一张meta表，主要字段也就三个，外部ID, key,value. 然后id和key再起联合索引. 这样就没实际上和存放一个序列化的字段没区别，但解决了一些现实问题. 当然，可变字段太多的话，我觉得都能上mongoDB了 - Peakkk

回:　是一种思路，列式存储的思想. 但是一般的db上不建议用列式存储，因为不好读，查问题维护都不太弄，而且记录条数非常多，本身天然有分布式的需求，成本还是很大的 -　廖强

27. 按照业务线拆分，比如用户，订单，库存，商品等等分库，库再按某种特定算法分成多个库，分表就是字段拆分，主要靠业务场景 - xiaolv

28. 我们这的分表是按uid取模分库 再按年份分表. 扩展的时候 只能成倍扩展，还会出现冗余数据 - 波

回: 多个用户覆盖多个库 查起来不是很麻烦？

回: 用户都在redis里缓存着呢 - 波

29. 问: 如果按照时间分表了，合并查询怎么弄？ - a斌

回: 可以借助搜索引擎。所以在拆分业务的时候要足够想清楚基本的发展思路。 - 黑夜路人

回: 按时间分，多层查询比较合适， - sky

回: 大范围查询，一般都是各种统计。hadoop-->hive，应该可以 - 滕飞

30. 首先查当月表，如果不存在，继续查后面，这种比较适合社交网络，冷热数据，区分明显. 夸时间查询，和非夸时间可以采用不同的方案. 业务场景不同，方案也不同，业务上能切分就切分，也许用户经常查是个统计数据，这些既可以做缓存. 触发更新  - sky

31. 用户信息，如果关联不紧密，大部分都是可以分库分表的。查询业务一般都是统计或者数据分析相关需求。这种一般非实时，不论你是灌入mongodb也好，还是hadoop也好，相信都是可以解决的。
而单个用户来说，肯定关注自己的用户信息（登陆、查询、修改密码、积分增减），不关注别人的信息，一般这个关联不会太紧密。
所以一般分库分表是可以搞定的。
是否按照时间分表，可以按照具体业务，一般来说，hash之类的分表应该足够。
- 黑夜路人

32. 问: sharding后事务大家一般怎么处理啊 - h2ero

回: @h2ero 如果你sharding 还有事务问题，那说明你sharding就有问题了。
至少你应该是符合业务的，很少事务类操作才是合理的。
不过有特殊场景可能会有，比如积分传递，从A用户把积分传递到B用户，会存在事务问题。
这种情况，那就借助软事务了，比如在mc/redis里种一个原子操作锁，然后进行操作，没有拿到锁的一概不让操作，操作完成释放锁。
举例，在mc里种一个原子操作的incr/decr操作，比如key是：uid1234_lock = 1，如果一直是1的情况，意味着有人在操作，如果为0，说明释放了锁，就可以操作了，然后一直while(1) 检测锁是否释放，释放了就开始操作，保证大家操作是互斥的。
缺点是性能不太好。
如果是 c/java/golang 那就在一个服务I里完成这个操作，在这个服务里自己种一个互斥锁（pthread_mutex），这样效率高些。
失败了就rollback呗，然后释放锁。
- 黑夜路人

33. 代码逻辑要写好. 尽量规避跨库的事务操作。
理论上来说，一般在一个库的事务是米问题的。
比如说，A用户在1表，B用户在2表，它俩都在user库里，那么直接操作就行了。
不是所有的sharding都需要跨库或者跨机器的。
start transaction;
select * from 1 where A = 1234;
update score=score+x from 1 where A = 1234 where score > x;
update score=score-x from 2 where B = 3456 where score > x;
commit;  //or rollback
第二个update错了，恩，可以不判断score. - 黑夜路人

回: 这时候就需要支持分布式事务的数据库了，哈哈 - 廖强

回: 一般业务大部分场景都能够搞定了，需要上分布式数据库，那业务要足够复杂足够大。 - 黑夜路人

34. 分布式事务数据库与分布式数据库不太一样. 如果有强一致性的需求，就会有这个需求，比如支付业务. 单机的瓶颈在那里摆着的，总会走到这一步的 - 廖强


【分享链接】

1. 一些国外优秀的elasticsearch使用案例 http://blog.csdn.net/july_2/article/details/24779533 - xiasix

2. 开源搜索引擎评估:lucene sphinx elasticsearch   http://lutaf.com/158.htm - xiasix

3. 风云有篇blog谈了排行榜的问题 你可以看看 http://blog.codingnow.com/2014/03/mmzb_db_2.html - 孔德文